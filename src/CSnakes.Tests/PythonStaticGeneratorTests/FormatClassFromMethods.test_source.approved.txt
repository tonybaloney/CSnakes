// <auto-generated/>
#nullable enable

#pragma warning disable PRTEXP001, PRTEXP002, CS0028

using CSnakes.Runtime;
using CSnakes.Runtime.Python;

using System;
using System.Collections.Generic;
using System.Collections.Immutable;
using System.Diagnostics;
using System.Reflection.Metadata;
using System.Text;
using System.Threading;
using System.Threading.Tasks;

using Microsoft.Extensions.Logging;

[assembly: MetadataUpdateHandler(typeof(Python.Generated.Tests.TestClassExtensions))]

namespace Python.Generated.Tests;

static partial class TestClassExtensions
{
    private static ITestClass? instance;

    private static ReadOnlySpan<byte> HotReloadHash => "839cf2c755bd926f41f87511ad9f6f1f"u8;

    public static ITestClass TestClass(this IPythonEnvironment env)
    {
        if (instance is null)
        {
            instance = new TestClassInternal(env.Logger);
        }
        System.Diagnostics.Debug.Assert(!env.IsDisposed());
        return instance;
    }

    public static void UpdateApplication(Type[]? updatedTypes)
    {
        instance?.ReloadModule();
    }

    private class TestClassInternal : ITestClass
    {
        private PyObject module;
        private readonly ILogger<IPythonEnvironment>? logger;

        private PyObject __func_get_mad_string;

        internal TestClassInternal(ILogger<IPythonEnvironment>? logger)
        {
            this.logger = logger;
            using (GIL.Acquire())
            {
                logger?.LogDebug("Importing module {ModuleName}", "test");
                this.module = ThisModule.Import();
                this.__func_get_mad_string = module.GetAttr("get_mad_string");
            }
        }

        void IReloadableModuleImport.ReloadModule()
        {
            logger?.LogDebug("Reloading module {ModuleName}", "test");
            using (GIL.Acquire())
            {
                Import.ReloadModule(ref module);
                // Dispose old functions
                this.__func_get_mad_string.Dispose();
                // Bind to new functions
                this.__func_get_mad_string = module.GetAttr("get_mad_string");
            }
        }

        public void Dispose()
        {
            logger?.LogDebug("Disposing module {ModuleName}", "test");
            this.__func_get_mad_string.Dispose();
            module.Dispose();
        }

        public string GetMadString()
        {
            using (GIL.Acquire())
            {
                this.logger?.LogDebug("Invoking Python function: {FunctionName}", "get_mad_string");
                PyObject __underlyingPythonFunc = this.__func_get_mad_string;
                using PyObject __result_pyObject = __underlyingPythonFunc.Call([]);
                var __return = __result_pyObject.BareImportAs<string, global::CSnakes.Runtime.Python.PyObjectImporters.String>();
                return __return;
            }
        }
    }
}

/// <summary>
/// Represents functions of the Python module <c>test</c>.
/// </summary>
public interface ITestClass : IReloadableModuleImport
{
    /// <summary>
    /// Invokes the Python function <c>get_mad_string</c>:
    /// <code><![CDATA[
    /// def get_mad_string() -> str: ...
    /// ]]></code>
    /// </summary>
    string GetMadString();
}

file static class ThisModule
{
    private static ReadOnlySpan<byte> source => """"
        def get_mad_string() -> str:
            """
            Returns a string with various Unicode characters.

            Do not remove this comment as it tests that triped-quoted Python strings are
            safe to embed into the generated C# code and will not break compilation.
            """

            return (
                'A'            # ASCII (1 byte)
                'Â¢'            # U+00A2 (2 bytes)
                'à¤¹'            # U+0939 (3 bytes)
                'ð„ž'            # U+1D11E (4 bytes, musical symbol)
                'ðŸ¦‹'           # U+1F98B (4 bytes, butterfly emoji)
                'ï¿½'            # U+FFFD (replacement character)
                '\u0301'       # U+0301 (combining acute accent)
                'Ã±'            # U+00F1 (precomposed accented letter)
                '\u202E'       # U+202E (right-to-left override)
                'ðŸ³ï¸â€ðŸŒˆ'           # Emoji sequence: white flag + ZWJ + rainbow
            )

        """"u8;

    public static PyObject Import() =>
        CSnakes.Runtime.Python.Import.ImportModule("test", source, "test.py");
}
